---
title: "Disruption Testing"
output: 
  html_document:
    self_contained: true
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: false
params:
  base_scen: 'C:\FTOT\scenarios\reference_scenarios\rs7_capacity'
  background_flows: FALSE
  do_volume: FALSE
---

<!-- Add the following line manually to the rendered HTML document so that IE does not block the javascript elements: -->
<!-- saved from url=(0014)about:internet --> 

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(warn = -1) # Suppress warnings

use_lib <- ifelse(any(grepl("FTOTnetworkEnv", .libPaths())),
  .libPaths()[grepl("FTOTnetworkEnv", .libPaths())],
  .libPaths()
)

suppressPackageStartupMessages(library(ggplot2, lib.loc = use_lib))
suppressPackageStartupMessages(library(dplyr, lib.loc = use_lib))
suppressPackageStartupMessages(library(tidyr, lib.loc = use_lib))
suppressPackageStartupMessages(library(DT, lib.loc = use_lib))
suppressPackageStartupMessages(library(plotly, lib.loc = use_lib))
suppressPackageStartupMessages(library(knitr, lib.loc = use_lib))
suppressPackageStartupMessages(library(sf, lib.loc = use_lib))
suppressPackageStartupMessages(library(rlist, lib.loc = use_lib))
#suppressPackageStartupMessages(library(basemaps, lib.loc = use_lib))
suppressPackageStartupMessages(library(leaflet, lib.loc = use_lib))
suppressPackageStartupMessages(library(htmltools, lib.loc = use_lib))


scen_name = basename(file.path(params$base_scen))
```

__Scenario Name:__ `r scen_name`  
__Report Date:__ `r Sys.Date()`

The FTOT Link Removal tool assesses how resilient an optimal solution is to the removal of key links in the network. The tool removes road links from the network one-by-one in order of importance, each time  re-solving for the optimal routing solution and the new scenario cost. Link importance is based either on a network property known as betweenness centrality or on the volume of vehicles on roadway links.

Results for the scenario __`r scen_name`__ are presented below.

## Scenario Cost by Disruption Step

The graph below presents total scenario cost (or optimization objective value) versus the disruption step. At each step, another road link is removed. For example, in the first disruption step, the most important road link is removed from the network. In the second disruption step, the second most important link is removed, and so on. The color of the points corresponds to the number of roadway links (edges) remaining in the network after each disruption. Scenario costs will remain the same or increase with each successive disruption but should never decrease.

```{r BC_disrupt}
disrupt_type = 'BC'

disrupt_root = paste(params$base_scen, disrupt_type, 'disrupt', sep = '_')

res = read.csv(file.path(disrupt_root, 'Results.csv'))

# clean up commas
res$total_cost <- as.numeric(sub('\\,', '', res$total_cost))

g1 <- ggplot(res, aes(x = disrupt_step, 
                      y = total_cost)) +
  geom_step(size = 2, color = 'grey80') +
  geom_point(size = 2, aes(color = nedge)) +
  theme_bw() +
  #ggtitle('Scenario Cost by Disruption Step') +
  labs(x = 'Disruption Step', y = 'Scenario Cost', color = '# of Edges')

#ggsave(plot = g1, filename = paste0(scen_name, '_BC_Disruption_Cost.jpg'))

ggplotly(g1)

```

## Maps {.tabset}
The maps below show the optimal road network in the baseline scenario and highlight up to 10 links by importance ranking or by scenario cost.

### Symbologize By Rank
The map below plots the optimal route in the baseline scenario and highlights the top ten links by importance. Hover over each highlighted link to see its Net Source OID (link identifier) and rank.

```{r map_rank, fig.width=8, echo=FALSE}

# Read in main GDB
base_route = st_read(dsn = file.path(params$base_scen, 'main.gdb'), layer = 'optimized_route_segments', quiet = TRUE)
base_route <- base_route['NET_SOURCE_OID']
edges <- read.csv(file.path(params$base_scen, 'Edges_to_Remove.csv'))
edges['Rank'] = 1:nrow(edges)
edges <- edges[1:10,]

route_w_rank = merge(base_route, edges, by.x='NET_SOURCE_OID', by.y = 'mode_oid', all.x = TRUE)
#route_w_rank[is.na(route_w_rank['Rank']), 'Rank'] <- NA
route_w_rank[is.na(route_w_rank['Rank']), 'Rank'] <- 0


#https://learning.nceas.ucsb.edu/2019-11-RRCourse/spatial-vector-analysis-using-sf.html#visualize-sf-objects-with-leaflet

route_w_rank <- route_w_rank %>% st_transform(crs = 4326)

labels <- paste('Net Source OID:', route_w_rank[route_w_rank$Rank != "0",]$NET_SOURCE_OID,
                '<br>Rank:', route_w_rank[route_w_rank$Rank != "0",]$Rank) %>%
          lapply(htmltools::HTML)


pal <- colorNumeric(
  palette = "YlOrRd",
  domain = route_w_rank[route_w_rank$Rank != "0",]$Rank,
  reverse = TRUE
)

leaflet(route_w_rank) %>%
  addProviderTiles('Esri.WorldGrayCanvas') %>%
  addPolylines(color='gray', opacity=1, weight = 2) %>%
  addPolylines(data = route_w_rank[route_w_rank$Rank != "0",],
               color = ~pal(route_w_rank[route_w_rank$Rank != "0",]$Rank),
               opacity = 1,
               weight = 8,
               label = ~labels,
               labelOptions = labelOptions(textsize='12px')) %>%
  addLegend(pal = pal,
            values = route_w_rank[route_w_rank$Rank != "0",]$Rank,
            opacity = 1)
  


```

### Symbologize By Total Cost
The top ranked links for importance are removed from the network one-by-one in subsequent disruption scenarios. The map below plots the optimal road links in the baseline scenario and highlights each rank removed based on the resulting scenario cost in the associated disruption scenario.

```{r map_cost, fig.width=8, echo=FALSE}
route_w_rank_res = merge(route_w_rank, res, by.x='Rank', by.y = 'disrupt_step', all.x = TRUE)
route_w_rank_res <- route_w_rank_res[!duplicated(route_w_rank_res),]
route_w_rank_res <- route_w_rank_res[order(route_w_rank_res$Rank),]
route_w_rank_res[is.na(route_w_rank_res['total_cost']), 'total_cost'] <- NA

labels <- paste('Net Source OID:', route_w_rank_res[!is.na(route_w_rank_res$total_cost),]$NET_SOURCE_OID,
                '<br>Rank:', route_w_rank_res[!is.na(route_w_rank_res$total_cost),]$Rank,
                '<br>Scenario Cost:', route_w_rank_res[!is.na(route_w_rank_res$total_cos),]$total_cost) %>%
          lapply(htmltools::HTML)

pal <- colorNumeric(
  palette = "YlOrRd",
  domain = route_w_rank_res$total_cost
)

leaflet(route_w_rank_res) %>%
  addProviderTiles('Esri.WorldGrayCanvas') %>%
  addPolylines(color='gray', opacity=1, weight = 2) %>%
  addPolylines(data = route_w_rank_res[!is.na(route_w_rank_res$total_cost),],
               color= ~pal(total_cost),
               opacity = 1,
               weight = 8,
               label = ~labels,
               labelOptions = labelOptions(textsize='12px')) %>%
  addLegend(pal = pal,
            values = ~route_w_rank_res[!is.na(route_w_rank_res$total_cost),]$total_cost,
            title = 'Total Cost')

```


## Relationship of Betweenness Centrality and Volume

The scatter plot below shows the relationship between betweeness centrality and  background vehicle flows for links used in the optimal solution of the baseline scenario. Each roadway segment in the optimal solution is represented by a point. Points are colored by their importance ranking, in terms of either volume or betweeneess centrality depending on user settings in the Link Removal tool. This plot appears only for scenarios run with background flows turned on in the FTOT scenario XML file.


```{r bc_vol, fig.width=10}
edges <- read.csv(file.path(params$base_scen, 'Edges_to_Remove.csv'))

e_bc <- edges[order(edges$sum_BC, decreasing = T),] %>%
  mutate(BC_rank = order(sum_BC, decreasing = T))

e_v <- edges[order(edges$volume, decreasing = T),] %>%
  mutate(V_rank = order(volume, decreasing = T))

e_j <- full_join(e_bc, e_v)

g2_v <- ggplot(e_j, aes(x = volume, 
                      y = sum_BC)) +
  geom_point(aes(color = V_rank), size = 3) +
  theme_bw() +
  labs(x = 'Volume', y='Betweeness Centrality (BC)', color = 'Volume Rank')

g2_bc <- ggplot(e_j, aes(x = volume, 
                      y = sum_BC)) +
  geom_point(aes(color = BC_rank), size = 3) +
  labs(x = 'Volume', y='Betweeness Centrality (BC)', color = 'BC Rank') +
  theme_bw()

if (params$do_volume){
g2_v
} else {
  g2_bc
}


```

## Table of Ranked Segments

The table below lists the segment links that were ranked by importance. Links were iteratively removed in subsequent disruption scenario in order of ranking up to the user-specified __`r nrow(res)` disruption steps__.

```{r edge_table}

datatable(e_j  %>% filter(!is.na(BC_rank) | !is.na(V_rank)) %>%
            select(BC_rank,
                   V_rank,
                   edge_id,
                   length,
                   capacity,
                   volume,
                   sum_BC,
                   mode_oid),
          caption = paste("Road segments (edges) disrupted in", scen_name),
          rownames = F,
          filter = 'top',
          options = list(dom = "ftp",
                         pageLength = 10)
          ) %>% formatRound(4:5, digits = 2) 

```
